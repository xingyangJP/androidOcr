# 📱 要件定義書：ロゴ・鏡文字認識アプリ（プロトタイプ版）

## 1. 概要
## アプリ名
「RecoLens」

本アプリ「**RecoLens**」は、**オフライン環境でロゴおよび鏡文字を認識**するAndroidアプリのプロトタイプである。  
認識モデルの精度検証を目的として、ユーザーが**ロゴを登録し、認識後に人の目で確認する検証UI**を備える。  
また、**1つの会社・ブランド名に複数のロゴバリエーションを紐づけて登録・管理**できる仕組みを持つ。

---

## 2. システム構成概要

| 区分 | 内容 |
|------|------|
| プラットフォーム | Android（最低SDK 26） |
| 言語 | Kotlin |
| フレームワーク | Jetpack Compose + CameraX |
| 画像解析 | OpenCV for Android |
| 推論エンジン | TensorFlow Lite（ロゴ分類: 転移学習モデル + 端末内kNN、OCR: 既存TFLite） |
| 動作条件 | 完全オフライン動作 |
| 保存方式 | Room（SQLiteローカルDB） |

---

## 3. 主な機能一覧

| 機能カテゴリ | 機能名 | 機能概要 |
|---------------|----------|------------|
| 🔍 認識機能 | カメラ撮影・解析 | カメラ映像からリアルタイムにロゴ・文字を検出・分類。鏡文字の場合は自動補正。 |
| 🏷 登録機能 | ロゴ登録 | 任意のロゴ画像を登録し、ラベル（会社名・ブランド名）を付与。**1社に対して複数のロゴを登録可能。** |
| 👁️ 検証機能 | 認識結果確認 | 認識後に「正しく認識できたか」を人が目視でチェックする画面を提供。 |
| 💾 保存機能 | 結果履歴 | 認識結果・撮影日時・画像サムネイル・確認ステータス（OK/NG）をローカルDBに保存。 |
| ⚙️ 設定機能 | 基本設定 | テーマ切替（ライト/ダーク）、ミラー補正のON/OFF設定。 |

---

## 4. 機能詳細

### 4.1 ロゴ登録機能

**目的:**  
認識対象のロゴを手動登録し、試験用データセットをアプリ内で作成。  
1つの会社・ブランドに対して複数のロゴ画像を紐づけて登録できる。

**仕様:**
- 登録画面で以下を入力：
  - ロゴ画像（撮影 or ギャラリー選択）
  - ブランド名（例：TOYOTA, SONYなど）
  - カテゴリ（任意）
  - 備考（例：旧ロゴ・海外版ロゴ・モノクロ版など）
- 登録完了時にロゴ画像から特徴ベクトル（例: 128次元）を算出し、ブランドIDと紐づけてローカルDBへ保存。  
  → 次回推論からkNN類似検索で即時活用される。
- 同一ブランド名を選択すると、そのブランド配下に追加登録される。
- 登録データ構造（例）：

```kotlin
@Entity(tableName = "brands")
data class Brand(
    @PrimaryKey(autoGenerate = true) val brandId: Int = 0,
    val name: String
)

@Entity(
    tableName = "logos",
    foreignKeys = [ForeignKey(
        entity = Brand::class,
        parentColumns = ["brandId"],
        childColumns = ["brandId"],
        onDelete = CASCADE
    )]
)
data class Logo(
    @PrimaryKey(autoGenerate = true) val logoId: Int = 0,
    val brandId: Int,
    val imagePath: String,
    val description: String?,
    val registeredAt: Long
)


⸻

4.2 カメラ認識機能

目的:
CameraXでリアルタイムプレビューを表示し、ロゴ・文字を検出。

仕様:
	•	プレビュー上で検出領域を矩形で表示。
	•	鏡文字と判断された場合、自動的に水平反転してOCRに渡す。
	•	推論結果（ロゴ名 / テキスト内容 / 信頼度スコア）を即時表示。
	•	同一ブランドの複数ロゴにマッチする場合は候補一覧を提示。
	•	例：「TOYOTA（丸ロゴ）」「TOYOTA（筆記体）」など。

⸻

4.3 認識確認画面（人の目でチェックするUI）

目的:
AIの認識結果を人が正誤判定するための画面。

仕様:
	•	認識完了後、自動で「確認画面」へ遷移。
	•	画面構成：

[認識結果確認画面]

 ┌──────────────────────────┐
 │ 撮影画像サムネイル（中央表示）       │
 │                                    │
 │ [認識結果]  TOYOTA（信頼度 92%）      │
 │ [候補ロゴ]   丸ロゴ / 筆記体 / 旧ロゴ   │
 │ [OCR結果]   “TOYOTA MOTOR”           │
 │                                    │
 │ ❍ 正しい   ❍ 間違い（再登録）         │
 │ [確認送信] ボタン                    │
 └──────────────────────────┘

	•	「正しい」選択時 → 状態を「CONFIRMED_OK」として履歴に保存。
	•	「間違い」選択時 → 「ロゴ登録画面」を開き、正しいラベルを再登録可能。
	•	チェック結果は学習データ拡張に活用可能。

⸻

4.4 履歴管理

目的:
すべての認識結果を再確認できるように履歴を保持。

仕様:
	•	一覧形式で表示（最新順）
	•	サムネイル / 認識ブランド / 確認ステータス / 日時
	•	詳細タップで「再確認」可能。
	•	DB構造（Room Entity）例：

@Entity(tableName = "recognition_results")
data class RecognitionResult(
    @PrimaryKey(autoGenerate = true) val id: Int = 0,
    val imagePath: String,
    val detectedBrand: String?,
    val detectedLogoId: Int?, // 複数ロゴに対応
    val detectedText: String?,
    val confidence: Float,
    val verified: Boolean?, // null=未確認, true=正しい, false=誤り
    val createdAt: Long
)


⸻

### 4.5 モデル学習・更新方針

**ロゴ分類モデル（Logo Classification）**
- 開発工程でMobileNetV3 / EfficientNet-Liteなどの汎用モデルをベースに転移学習し、TFLite化したモデルをアプリに同梱する。
- 運用時は端末内で推論を行い、新規登録ロゴは特徴ベクトルとしてローカルDBへ追加するだけで即時反映される。
- 必要に応じて端末からロゴ画像を吸い上げ、開発者PCや一時的な学習環境で再度バッチ転移学習を行い、アップデート版TFLiteをアプリ更新として配布する。

**OCRモデル（文字認識）**
- Google ML KitやTesseract/PaddleOCRの既存TFLiteモデルを利用し、オフラインでOCRを実行。
- 英数字を中心に、Tesseractの日本語学習データを導入することでひらがな・カタカナにも一部対応。漢字は限定的に認識。
- フォントは明朝・ゴシックなどの一般フォントを想定し、装飾フォントや筆記体はロゴ分類側でカバーする。

**運用ポリシー**
- 常設サーバは不要で、通信無しの完全オフラインで利用可能。
- 再学習は開発工程でのみ実施し、現場では端末1台で撮影・認識・履歴保存・特徴追加が完結する。

⸻

5. 画面構成一覧

画面名	主要要素	遷移元 / 遷移先
🏠 メイン画面	カメラプレビュー / 認識結果表示 / 撮影ボタン	起動時 → 認識確認画面
🧾 ロゴ登録画面	ブランド選択 / ロゴ画像追加 / 備考入力 / 登録ボタン	手動 or 誤認識時遷移
✅ 認識確認画面	撮影画像 / 結果 / 候補ロゴ / 正誤ボタン / 再登録リンク	メイン → 確認 → 履歴
📜 履歴一覧画面	認識結果リスト / ブランド名 / ステータス / 詳細ボタン	メニュー → 詳細画面


⸻

6. UIデザイン指針
	•	テーマ: ダークグレー + シルバーアクセント
	•	トーン: シンプル・モダン・工業的（現場利用を想定）
	•	操作: 片手操作を意識したボタン配置
	•	アニメーション: 認識時に矩形ハイライトと軽微な振動フィードバック

⸻

7. 画面遷移図（ワイヤーフレーム）

┌────────────────────────────┐
│        起動画面（Splash）         │
│   - アプリアイコン / タイトル表示 │
│   - 2秒後 自動でメイン画面へ      │
└──────────────┬────────────┘
                │
                ▼
┌────────────────────────────┐
│ 🏠 メイン画面（CameraView）          │
│  - CameraXプレビュー                 │
│  - [撮影]ボタン → 認識確認画面       │
│  - [履歴]ボタン → 履歴一覧画面       │
│  - [登録]ボタン → ロゴ登録画面       │
└────┬───────────────┘
      │ 撮影後
      ▼
┌────────────────────────────┐
│ ✅ 認識確認画面                      │
│  - 撮影画像 / 結果 / 候補ロゴ一覧    │
│  - [正しい] → 履歴保存             │
│  - [間違い] → ロゴ登録画面         │
│  - [戻る] → メイン画面             │
└────┬───────────────┘
      │ 間違い選択
      ▼
┌────────────────────────────┐
│ 🧾 ロゴ登録画面                      │
│  - ブランド選択 / 画像選択           │
│  - 複数ロゴを同一ブランドに紐づけ   │
│  - [登録]ボタン → メイン画面戻る    │
└────────────────────────────┘

      ▼
┌────────────────────────────┐
│ 📜 履歴一覧画面                      │
│  - 認識履歴リスト（確認済み/未確認）│
│  - ブランド・ロゴバリエーション表示  │
│  - [詳細]タップ → 再確認画面        │
│  - [戻る] → メイン画面             │
└────────────────────────────┘


⸻

8. 非機能要件

項目	内容
動作モード	完全オフライン
応答時間	推論結果まで 1秒以内（ローカルモデル推論）
モデルサイズ	〜80MB以内
データ保存	端末ローカルのみ。外部通信なし。
権限	カメラ / ストレージのみ要求。


⸻

9. 開発スケジュール（試作版）

フェーズ	期間	内容
Week 1–2	設計・UIモックアップ（Compose）	
Week 3–4	カメラ + OpenCV + 推論統合	
Week 5–6	ロゴ登録・確認画面・履歴管理実装（複数ロゴ紐づけ対応）	
Week 7	動作確認・UI調整・デモ作成	


⸻

10. 成果物
	•	Androidアプリ（APK形式）
	•	テスト用サンプルロゴデータ（複数ロゴを持つブランド含む）
	•	検証用ログ（認識結果 + 正誤判定）
	•	`sampleLogo/` ディレクトリ（実装初期向けのサンプルロゴ画像一式）

⸻

11. 開発環境セットアップ

- Android Studio Giraffe以降 / JDK 17 を推奨。
- 初回のみ `gradle wrapper` 実行（環境にGradleが無い場合は `./gradlew wrapper --gradle-version 8.4` などで生成）。
- セットアップ後に `./gradlew :app:assembleDebug` を実行し、ComposeベースのSkeletonアプリがビルドできることを確認する。

⸻

12. 実機テスト手順（USB接続）

1. Android端末で開発者向けオプションを有効化し、「USBデバッグ」をONにする。  
   端末とMacをUSBケーブルで接続し、端末側で「このPCを許可しますか？」にOKする。
2. macOS側にGradleが無い場合は `brew install gradle` 等で一度だけ導入し、プロジェクト直下で `gradle wrapper --gradle-version 8.4` を実行して Wrapper を生成する。  
   （Android Studio の「Sync Project with Gradle Files」でも生成可能）
3. 端末が認識されているか `adb devices` で確認する。リストに端末IDが表示されれば準備完了。
4. `./gradlew installDebug` を実行すると、ビルドされたAPKがUSB経由で端末にインストールされる。  
   - ビルドのみ行う場合は `./gradlew :app:assembleDebug` → `adb install app/build/outputs/apk/debug/app-debug.apk` でも可。
5. 端末で「RecoLens」アプリを起動し、カメラや登録フローの動作を確認する。
